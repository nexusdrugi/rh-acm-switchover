name: RPM Build

on:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install rpm build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y rpm rpm2cpio python3 python3-pip
      - name: Build Python wheel
        run: |
          python3 -m pip install build
          python3 -m build .
      - name: Prepare SOURCES tarball
        run: |
          mkdir -p rpmbuild/SOURCES
          git archive --format=tar.gz --output rpmbuild/SOURCES/rh-acm-switchover-$(cat packaging/common/VERSION).tar.gz HEAD
      - name: Build RPM (spec skeleton)
        run: |
          rpmbuild --define "_topdir $(pwd)/rpmbuild" -ba packaging/rpm/acm-switchover.spec
      - name: Smoke test RPM install
        if: always()
        run: |
          RPM_PKG=$(ls rpmbuild/RPMS/noarch/*.rpm | head -n1 || true)
          if [ -n "$RPM_PKG" ]; then
            sudo rpm -i "$RPM_PKG"
            acm-switchover --version
          else
            echo "No RPM built; skipping smoke test"
          fi
